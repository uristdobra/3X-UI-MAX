АРХИТЕКТУРА 3X-UI PRO INSTALLER v2.0
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛИ / КЛИЕНТЫ                             │
├──────────────┬──────────────┬──────────────┬──────────────┬────────────────┤
│  Sing-box    │  Clash Meta  │   v2rayN    │  v2rayNG     │  Другие        │
│              │              │             │              │                │
│  iOS/Android │  iOS/Android │  Windows    │   Android    │  WireGuard     │
└──────────────┴──────────────┴──────────────┴──────────────┴────────────────┘
                                      ▲
        ┌─────────────────────────────┼─────────────────────────────┐
        │         ИНТЕРНЕТ / CDN      │       REALITY (TCP+gRPC)    │
        │                             │                             │
    ┌───┴────┐                   ┌────┴──────┐
    │  HTTP  │                   │   HTTPS   │
    │  Port  │                   │  Port 443 │
    │   80   │                   │           │
    └────┬───┘                   └────┬──────┘
         │                            │
         └────────────┬───────────────┘
                      │
        ┌─────────────▼───────────────┐
        │                             │
        │       NGINX LAYER           │
        │   (Reverse Proxy)           │
        │                             │
        │  - HTTP → HTTPS redirect    │
        │  - SSL/TLS termination      │
        │  - Load balancing           │
        │  - DDoS mitigation          │
        │  - Caching & compression    │
        │                             │
        └──────────────┬──────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
    ┌────────┐   ┌────────┐   ┌─────────────┐
    │/ws     │   │/xray   │   │/xhttp       │
    │(WS)    │   │(gRPC)  │   │(HttpUpgrade)│
    └────┬───┘   └────┬───┘   └──────┬──────┘
         │            │              │
         │            │              │
    127.0.0.1:10004  10002         10003
         │            │              │
         └────────────┼──────────────┘
                      │
        ┌─────────────▼─────────────┐
        │                           │
        │    3X-UI CONTAINER        │
        │    (Docker)               │
        │                           │
        │  - Admin Panel (8080)     │
        │  - REST API (54321)       │
        │  - Xray Core              │
        │                           │
        └─────────────┬─────────────┘
                      │
        ┌─────────────┴─────────────────────────────┐
        │                                           │
        ▼                                           ▼
    ┌───────────────────────────┐     ┌──────────────────────────────┐
    │  ИНБАУНДЫ XRAY            │     │  ОЧЕРЕДИ И ОБРАБОТКА         │
    │                           │     │                              │
    │  Port 10001 TCP/Reality   │     │  - Sniffing                  │
    │  Port 10002 gRPC/Reality  │     │  - Load balancing            │
    │  Port 10003 HttpUpgrade   │     │  - User management           │
    │  Port 10004 WebSocket/TLS │     │  - Traffic statistics        │
    │  Port 10005 VMess/TCP     │     │  - Rate limiting             │
    │  Port 10006 Trojan/Reality│     │                              │
    │  Port 10007 ShadowSocks   │     │  БД:                         │
    │                           │     │  - /opt/3xui/db/x-ui.db      │
    └───────────────────────────┘     └──────────────────────────────┘
                      │                           │
                      └───────────────┬───────────┘
                                      │
                          ┌───────────▼────────────┐
                          │                        │
                          │  ИСХОДЯЩИЙ ТРАФИК     │
                          │  (Outbound)            │
                          │                        │
                          │  - Direct              │
                          │  - Freedom             │
                          │  - Proxy chains        │
                          │                        │
                          └────────────────────────┘
                                      │
                          ┌───────────▼────────────┐
                          │                        │
                          │   ЦЕЛЕВОЙ СЕРВЕР      │
                          │                        │
                          │  - HTTP/HTTPS         │
                          │  - Streaming           │
                          │  - Messaging           │
                          │  - Другой трафик      │
                          │                        │
                          └────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════

КОМПЛЕКТЫ УСТАНОВКИ:
═══════════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 1: ПОДГОТОВКА СЕРВЕРА                                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ✓ Обновление системы (apt update && full-upgrade)                          │
│  ✓ Установка утилит: curl, wget, jq, lsof, net-tools, ufw, cron, socat    │
│  ✓ Проверка портов: 22, 80, 443, 8080, 54321, 10001-10007                 │
│  ✓ Отключение UFW (на время установки)                                     │
│  ✓ Оптимизация sysctl:                                                      │
│    - TCP буферы (rmem/wmem до 64MB)                                         │
│    - BBR congestion control                                                 │
│    - Параметры соединения (max_tw_buckets, ip_local_port_range)             │
│  ✓ Очистка неиспользуемых пакетов                                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 2: ПАРАМЕТРЫ УСТАНОВКИ (интерактивно)                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ❓ Домен для панели и WebSocket/gRPC: panel.example.com                   │
│  ❓ REALITY SNI (destHost): www.microsoft.com                               │
│  ❓ Email для Let's Encrypt: admin@example.com                              │
│  ❓ Пароль администратора 3x-ui: [не отображается при вводе]               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 3: ВЫБОР ПРОТОКОЛОВ (интерактивно)                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. [Y] VLESS + REALITY TCP (основной stealth)                              │
│  2. [Y] VLESS + REALITY gRPC (DPI bypass)                                   │
│  3. [Y] VLESS + REALITY XHTTP (HttpUpgrade)                                 │
│  4. [Y] VLESS + WebSocket + TLS (CDN-friendly)                              │
│  5. [N] VMess + TCP (совместимость)                                         │
│  6. [N] Trojan + REALITY TCP (альтернативный stealth)                       │
│  7. [N] ShadowSocks + TCP (лёгкий протокол)                                 │
│                                                                              │
│  По умолчанию (Enter): 1,2,3,4                                              │
│  Выбрать всё: 1,2,3,4,5,6,7                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 4: УСТАНОВКА ЗАВИСИМОСТЕЙ                                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ✓ Docker                                                                   │
│  ✓ Docker Compose                                                           │
│  ✓ Nginx                                                                    │
│  ✓ Certbot & python3-certbot-nginx                                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 5: УСТАНОВКА 3X-UI                                                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ✓ Загрузка образа: ghcr.io/mhsanaei/3x-ui:latest (или x-ui-pro)          │
│  ✓ Создание docker-compose.yml                                              │
│  ✓ Запуск контейнера 3xui                                                   │
│  ✓ Проверка готовности API                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 6: КОНФИГУРИРОВАНИЕ NGINX                                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ✓ Создание временной конфиг для certbot                                   │
│  ✓ Получение SSL сертификата (Let's Encrypt)                               │
│  ✓ Создание основной конфиг:                                               │
│    - HTTP redirect (порт 80 → 443)                                          │
│    - Admin Panel (проксирование на 127.0.0.1:8080)                          │
│    - WebSocket endpoint (/ws → 127.0.0.1:10004)                             │
│    - gRPC endpoint (/xray → 127.0.0.1:10002)                                │
│    - XHTTP endpoint (/xhttp → 127.0.0.1:10003)                              │
│  ✓ Включение и проверка конфиг                                             │
│  ✓ Перезагрузка Nginx                                                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 7: СОЗДАНИЕ ИНБАУНДОВ                                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ✓ Генерация REALITY ключей (x25519)                                        │
│  ✓ Создание инбаундов через REST API 3x-ui:                                 │
│                                                                              │
│    Для VLESS (REALITY варианты):                                            │
│    - UUID: генерируется один на всех                                        │
│    - Private Key: из x25519                                                 │
│    - Public Key: из x25519                                                 │
│    - SNI: REALITY_SNI (www.microsoft.com)                                   │
│    - ShortIds: ["", "00"]                                                   │
│                                                                              │
│    Для Trojan:                                                              │
│    - Password: генерируется (openssl rand -base64 16)                       │
│                                                                              │
│    Для ShadowSocks:                                                         │
│    - Method: aes-256-gcm                                                    │
│    - Password: генерируется (openssl rand -base64 16)                       │
│                                                                              │
│  ✓ Сохранение credentials.txt                                              │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ РАЗДЕЛ 8: ФИНАЛЬНЫЕ ПРОВЕРКИ                                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ✓ Проверка контейнера 3xui (docker ps)                                    │
│  ✓ Проверка Nginx (systemctl status nginx)                                 │
│  ✓ Проверка портов (ss -tulpn)                                             │
│  ✓ Проверка SSL сертификата (openssl x509)                                 │
│  ✓ Вывод информации об установке                                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════

ФАЙЛОВАЯ СТРУКТУРА:
═══════════════════════════════════════════════════════════════════════════════

/opt/3xui/
│
├── docker-compose.yml          [Конфиг Docker Compose]
├── x-ui/                       [Клон репозитория 3x-ui]
├── db/
│   └── x-ui.db                [БД панели (SQLite)]
├── certs/
│   └── [SSL сертификаты]
├── backups/
│   └── 3xui-backup-*.tar.gz   [Резервные копии]
├── installation-config.txt     [Информация об установке]
└── credentials.txt             [UUID, пароли, ключи]

/etc/nginx/
│
├── sites-available/
│   └── 3xui-panel              [Основная конфиг]
├── sites-enabled/
│   └── 3xui-panel → [symlink]
└── nginx.conf, ...

/etc/letsencrypt/
│
└── live/panel.example.com/
    ├── fullchain.pem           [SSL сертификат]
    ├── privkey.pem             [Приватный ключ]
    ├── chain.pem               [Цепочка сертификатов]
    └── ...

~/.local/bin/
│
├── x-ui-pro-installer.sh       [Главный скрипт установки]
├── inbound-config.sh           [Функции создания инбаундов]
└── maintenance.sh              [Инструменты мониторинга]

═══════════════════════════════════════════════════════════════════════════════

ПОРТЫ И СЕРВИСЫ:
═══════════════════════════════════════════════════════════════════════════════

Внешние (для клиентов):
  80/TCP    - HTTP redirect
  443/TCP   - HTTPS (панель, WebSocket, gRPC, XHTTP)
  443/UDP   - QUIC (опционально)

Внутренние (только на сервере):
  8080/TCP  - 3x-ui Web Panel (через Nginx)
  54321/TCP - REST API 3x-ui (только localhost)

Xray Inbounds (прямые подключения):
  10001/TCP - VLESS + REALITY TCP
  10002/TCP - VLESS + REALITY gRPC
  10003/TCP - VLESS + REALITY XHTTP
  10004/TCP - VLESS + WebSocket + TLS
  10005/TCP - VMess + TCP
  10006/TCP - Trojan + REALITY TCP
  10007/TCP - ShadowSocks + TCP

═══════════════════════════════════════════════════════════════════════════════

ПОТОКИ ДАННЫХ:
═══════════════════════════════════════════════════════════════════════════════

VLESS REALITY TCP:
  Client (IP:PORT) → Server:10001 (REALITY) → Outbound → Internet

VLESS WebSocket:
  Client → Server:443 (HTTPS) → Nginx (/ws) → Server:10004 (WS) → Outbound

REALITY gRPC:
  Client → Server:10002 (gRPC + REALITY) → Outbound

Trojan REALITY:
  Client (password) → Server:10006 (REALITY) → Outbound

Admin Panel:
  Admin Browser → Server:443 (HTTPS) → Nginx → localhost:8080 → 3x-ui

═══════════════════════════════════════════════════════════════════════════════

ЦЕПОЧКА ИНИЦИАЛИЗАЦИИ:
═══════════════════════════════════════════════════════════════════════════════

1. Система инициализируется
   ↓
2. Docker запускает контейнер 3xui
   ↓
3. 3xui инициализирует БД (x-ui.db)
   ↓
4. Xray Core загружает конфигурацию и открывает inbounds (10001-10007)
   ↓
5. Nginx проксирует трафик с портов 80/443 на 8080, 10004, 10002, 10003
   ↓
6. Клиенты подключаются:
   - Напрямую к портам 10001, 10002, 10003, 10006, 10007 (REALITY, etc)
   - Через HTTPS к 443 (WebSocket/Admin)
   ↓
7. Исходящий трафик отправляется через Outbound конфиг Xray
   ↓
8. Данные передаются целевому серверу

═══════════════════════════════════════════════════════════════════════════════

КЛЮЧЕВЫЕ КОМПОНЕНТЫ:
═══════════════════════════════════════════════════════════════════════════════

┌─ Xray Core
│  └─ Inbound Handlers (VLESS, VMess, Trojan, ShadowSocks)
│     ├─ REALITY Security Module
│     ├─ TLS/mTLS Support
│     └─ Stream Settings (TCP, WebSocket, gRPC, HTTPUpgrade)
│
├─ 3x-ui Panel
│  ├─ Web Interface (HTML/CSS/JS)
│  ├─ REST API (Go)
│  ├─ SQLite Database
│  └─ Config Generator
│
├─ Nginx Reverse Proxy
│  ├─ HTTP/2 Support
│  ├─ SSL/TLS Termination
│  ├─ Load Balancing
│  └─ Protocol Translation (HTTP ↔ TCP, WebSocket, gRPC)
│
└─ Let's Encrypt / Certbot
   ├─ Automatic Certificate Generation
   ├─ ACME Protocol Implementation
   └─ Auto-Renewal Daemon

═══════════════════════════════════════════════════════════════════════════════

ВЕРСИЯ: 3X-UI PRO AUTO-INSTALLER v2.0
ДАТА: 2026-01-03
ЛИЦЕНЗИЯ: MIT (основана на upstream проектах)
